<?phpglobal $wpdb;session_start();if (!get_option("users_can_register")) {	if (!get_option("voa_allow_oauth_to_register_always")) {		$_SESSION["VOA"]["RESULT"] = "Sorry, user registration is disabled at this time. Your account could not be registered. Please notify the admin or try again later.";		header("Location: " . $_SESSION["VOA"]["LAST_URL"]);		exit;	}}$oauthUsername = $_SESSION["VOA"]["oauthUsername"];$email = $_SESSION["VOA"]["email"];$firstName = $_SESSION["VOA"]['firstName'];$lastName = $_SESSION["VOA"]['lastName'];if ($_SESSION["VOA"]["USER_ID"] != "") {	$username = $oauthUsername;	$password = wp_generate_password($length = 12, $include_standard_special_chars = true);}if ($_SESSION["VOA"]["USER_ID"] == "") {	$username = $_POST['identity'];	$password = $_POST['password'];}$user_id = wp_create_user($username, $password, $username);if (is_wp_error($user_id)) {	$_SESSION["VOA"]["RESULT"] = $user_id->get_error_message();	header("Location: " . $_SESSION["VOA"]["LAST_URL"]);	exit;}$update_username_result = wp_update_user(array('ID' => $user_id, 'user_email' => $email, 'user_nicename' => $oauthUsername, 'display_name' => $oauthUsername));update_user_meta($user_id, 'nickname', $oauthUsername);update_user_meta($user_id, 'first_name', $firstName);update_user_meta($user_id, 'last_name', $lastName);$role = get_option('voa_new_user_role');$update_role_result = wp_update_user(array('ID' => $user_id, 'role' => $role));if (!$update_username_result) {	var_dump($update_username_result);	die;	$_SESSION["VOA"]["RESULT"] = "Could not rename the username during registration. Please contact an admin or try again later.";	header("Location: " . $_SESSION["VOA"]["LAST_URL"]);	exit;} elseif ($update_role_result == false) {	$_SESSION["VOA"]["RESULT"] = "Could not assign default user role during registration. Please contact an admin or try again later.";	header("Location: " . $_SESSION["VOA"]["LAST_URL"]);	exit;} else {	$this->voa_link_account($user_id);	$creds = array();	$creds['user_login'] = $username;	$creds['user_password'] = $password;	$creds['remember'] = true;	$user = wp_signon($creds, false);	if (!get_option('voa_suppress_welcome_email')) {		wp_new_user_notification($user_id, null, "both");	}	$_SESSION["VOA"]["RESULT"] = "You have been registered successfully!";	$this->voa_login_user($oauth_identity);	exit;}