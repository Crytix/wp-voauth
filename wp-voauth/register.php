<?phpglobal $wpdb;session_start();if (!get_option("users_can_register")) {	if (!isset($_SESSION['VOA']['agent'])) {		$_SESSION["VOA"]["RESULT"] = "Sorry, user registration is disabled at this time. Your account could not be registered. Please notify the admin or try again later.";		header("Location: " . $_SESSION["VOA"]["LAST_URL"]);		exit;	}}if ($_SESSION["VOA"]["USER_ID"] != "") {	$username = uniqid('', true);	$password = wp_generate_password();}if ($_SESSION["VOA"]["USER_ID"] == "") {	$username = $_POST['identity'];	$password = $_POST['password'];}$user_id = wp_create_user($username, $password, $username); // we use wp_create_user instead of wp_insert_user so we can handle the error when the user being registered already existsif (is_wp_error($user_id)) {	$_SESSION["VOA"]["RESULT"] = $user_id->get_error_message();	header("Location: " . $_SESSION["VOA"]["LAST_URL"]);	exit;}$agent = $_SESSION["VOA"]["agent"];$update_username_result = $wpdb->update($wpdb->users, array('user_login' => $agent, 'user_nicename' => $agent, 'display_name' => $agent), array('ID' => $user_id));$update_nickname_result = update_user_meta($user_id, 'nickname', $agent);$role = get_option('voa_new_user_role');$update_role_result = wp_update_user(array('ID' => $user_id, 'role' => $role));if ($update_username_result == false || $update_nickname_result == false) {	$_SESSION["VOA"]["RESULT"] = "Could not rename the username during registration. Please contact an admin or try again later.";	header("Location: " . $_SESSION["VOA"]["LAST_URL"]);	exit;} elseif ($update_role_result == false) {	$_SESSION["VOA"]["RESULT"] = "Could not assign default user role during registration. Please contact an admin or try again later.";	header("Location: " . $_SESSION["VOA"]["LAST_URL"]);	exit;} else {	$this->voa_link_account($user_id);	$creds = array();	$creds['user_login'] = $username;	$creds['user_password'] = $password;	$creds['remember'] = true;	$user = wp_signon($creds, false);	if (!get_option('voa_suppress_welcome_email')) {		wp_new_user_notification($user_id, $password);	}	$_SESSION["VOA"]["RESULT"] = "You have been registered successfully!";	header("Location: " . $_SESSION["VOA"]["LAST_URL"]);	exit;}